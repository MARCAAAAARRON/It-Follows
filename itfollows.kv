#:kivy 2.2.0
#:import Window kivy.core.window.Window

<MenuScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(20)
        Label:
            text: 'It Follows'
            font_size: '32sp'
        Button:
            text: 'Play Game'
            size_hint_y: None
            height: dp(60)
            on_release: app.root.current = 'difficulty'

<DifficultyScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(10)
        Label:
            text: 'Select Difficulty'
            font_size: '28sp'
        Button:
            text: 'Normal'
            size_hint_y: None
            height: dp(50)
            on_release:
                app.root.get_screen('game').difficulty = 'normal'
                app.root.current = 'game'
        Button:
            text: 'Hard (battery drain)'
            size_hint_y: None
            height: dp(50)
            on_release:
                app.root.get_screen('game').difficulty = 'hard'
                app.root.current = 'game'
        Button:
            text: 'Extreme (drain + faster enemy)'
            size_hint_y: None
            height: dp(50)
            on_release:
                app.root.get_screen('game').difficulty = 'extreme'
                app.root.current = 'game'

<OverlayBox@BoxLayout>:
    orientation: 'vertical'
    padding: dp(16)
    spacing: dp(12)
    size_hint: 0.9, 0.7
    pos_hint: {'center_x': 0.5, 'center_y': 0.5}
    canvas.before:
        Color(0.1, 0.1, 0.2, 0.95)
        RoundedRectangle(pos=self.pos, size=self.size, radius=[15,])
        Color(0.3, 0.3, 0.5, 1)
        Line(rounded_rectangle=(self.x, self.y, self.width, self.height, 15), width=1.5)

<GameScreen>:
    BoxLayout:
        orientation: 'vertical'
        # HUD
        BoxLayout:
            size_hint_y: None
            height: dp(48)
            padding: dp(8)
            spacing: dp(12)
            Label:
                id: nightlbl
                text: root.night_text
                size_hint_x: None
                width: dp(130)
            Label:
                id: lightlbl
                text: root.light_text
                size_hint_x: None
                width: dp(100)
            Label:
                id: timelbl
                text: root.time_text
        # Game canvas
        Widget:
            id: gamecanvas
            canvas.before:
                PushMatrix
                Scale:
                    origin: self.center
                    xyz: 1.0, 1.0, 1.0
            canvas.after:
                PopMatrix
        # Touch controls
        BoxLayout:
            size_hint_y: None
            height: dp(120)
            padding: dp(8)
            spacing: dp(8)
            BoxLayout:
                size_hint_x: 0.6
                # D-pad like controls
                GridLayout:
                    cols: 3
                    rows: 3
                    Button:
                        text: ''
                        background_color: 0,0,0,0
                        disabled: True
                    Button:
                        text: 'Up'
                        on_press: root.move_up()
                        on_release: root.stop_v()
                    Button:
                        text: ''
                        background_color: 0,0,0,0
                        disabled: True
                    Button:
                        text: 'Left'
                        on_press: root.move_left()
                        on_release: root.stop_h()
                    Widget:
                    Button:
                        text: 'Right'
                        on_press: root.move_right()
                        on_release: root.stop_h()
                    Button:
                        text: ''
                        background_color: 0,0,0,0
                        disabled: True
                    Button:
                        text: 'Down'
                        on_press: root.move_down()
                        on_release: root.stop_v()
                    Button:
                        text: ''
                        background_color: 0,0,0,0
                        disabled: True
            BoxLayout:
                size_hint_x: 0.4
                orientation: 'vertical'
                Button:
                    text: 'Light'
                    size_hint_y: 0.6
                    on_release: root.use_light()
                Button:
                    text: 'Back to Menu'
                    size_hint_y: 0.4
                    on_release: app.root.current = 'menu'

    # Overlay (initially hidden)
    BoxLayout:
        id: overlay
        opacity: 0
        canvas.before:
            Color(0, 0, 0, 0.7)
            Rectangle(pos=self.pos, size=self.size)
        
        OverlayBox:
            orientation: 'vertical'
            padding: dp(20)
            spacing: dp(16)
            
            Label:
                id: overlay_text
                text: root.overlay_text
                text_size: self.width, None
                size_hint_y: 0.7
                valign: 'middle'
                halign: 'center'
                font_size: '18sp'
                color: 1, 1, 1, 1
                markup: True
                
            TextInput:
                id: riddle_input
                text: root.riddle_input
                multiline: False
                size_hint_y: None
                height: dp(50)
                font_size: '18sp'
                opacity: 1 if root.overlay_mode == 'riddle' else 0
                on_text: root.riddle_input = self.text
                
            BoxLayout:
                size_hint_y: None
                height: dp(50)
                spacing: dp(10)
                Button:
                    id: btn1
                    text: root.overlay_btn1
                    size_hint_x: 0.5 if root.overlay_btn2 else 1.0
                    on_release: root.overlay_action(1)
                Button:
                    id: btn2
                    text: root.overlay_btn2
                    size_hint_x: 0.5 if root.overlay_btn1 else 1.0
                    opacity: 1 if root.overlay_btn2 else 0
                    disabled: not root.overlay_btn2
                    on_release: root.overlay_action(2)
            
            BoxLayout:
                size_hint_y: None
                height: dp(50)
                spacing: dp(10)
                Button:
                    id: btn3
                    text: root.overlay_btn3
                    size_hint_x: 0.5 if root.overlay_btn4 else 1.0
                    opacity: 1 if root.overlay_btn3 else 0
                    disabled: not root.overlay_btn3
                    on_release: root.overlay_action(3)
                Button:
                    id: btn4
                    text: root.overlay_btn4
                    size_hint_x: 0.5 if root.overlay_btn3 else 1.0
                    opacity: 1 if root.overlay_btn4 else 0
                    disabled: not root.overlay_btn4
                    on_release: root.overlay_action(4)
    
    # Bind overlay visibility
    on_overlay_visible: overlay.opacity = 1.0 if self.overlay_visible else 0.0
    on_overlay_mode: 
        if self.overlay_mode == 'riddle':
            riddle_input.focus = True
        else:
            riddle_input.focus = False
